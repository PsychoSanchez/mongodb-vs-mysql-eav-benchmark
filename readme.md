# MongoDB vs MySQL EAV benchmark

This is a benchmark of MongoDB vs MySQL for EAV (Entity-Attribute-Value) data model. 

It tests bulk insert operations and get by entity id queries for 100000 entities with 100 attributes each.

Both MongoDB and MySQL are running in Docker containers, gateway is a Node.js app running fastify.

Test runs autoncannon requests from 100 connections over 30 seconds on a 2022 Macbook Pro M1 with 32GB RAM.

## Setup

Install docker and docker-compose.
Install nodejs dependencies:
```
nvm use && npm install
```

### MongoDB

Stop all docker containers
```
npm run stop:all
```

Start MongoDB container
```    
npm run start:mongo
```

Initialize MongoDB database
```
npm run init:mongo
```

### MySQL

Stop all docker containers
```
npm run stop:all
```

Start MySQL container
```
npm run start:mysql
```

Initialize MySQL database
```
npm run init:mysql
```

## Run benchmark

### MongoDB
```
npm run benchmark mongo
```

### MySQL
```
npm run benchmark mysql
```

## Results

### MongoDB

100000 entities average initialization time on 3 runs `21413ms`

10 connections x 30 seconds
```
┌─────────┬──────┬──────┬───────┬───────┬─────────┬─────────┬────────┐
│ Stat    │ 2.5% │ 50%  │ 97.5% │ 99%   │ Avg     │ Stdev   │ Max    │
├─────────┼──────┼──────┼───────┼───────┼─────────┼─────────┼────────┤
│ Latency │ 1 ms │ 2 ms │ 6 ms  │ 11 ms │ 2.08 ms │ 4.39 ms │ 390 ms │
└─────────┴──────┴──────┴───────┴───────┴─────────┴─────────┴────────┘
┌───────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────┐
│ Stat      │ 1%      │ 2.5%    │ 50%     │ 97.5%   │ Avg     │ Stdev   │ Min     │
├───────────┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┤
│ Req/Sec   │ 1209    │ 1209    │ 4183    │ 4495    │ 3871.97 │ 782.58  │ 1209    │
├───────────┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┤
│ Bytes/Sec │ 2.53 MB │ 2.53 MB │ 8.73 MB │ 9.39 MB │ 8.09 MB │ 1.63 MB │ 2.52 MB │
└───────────┴─────────┴─────────┴─────────┴─────────┴─────────┴─────────┴─────────┘

116k requests in 30.06s, 243 MB read
```

50 connections x 20 seconds
```
┌─────────┬──────┬──────┬───────┬───────┬─────────┬─────────┬───────┐
│ Stat    │ 2.5% │ 50%  │ 97.5% │ 99%   │ Avg     │ Stdev   │ Max   │
├─────────┼──────┼──────┼───────┼───────┼─────────┼─────────┼───────┤
│ Latency │ 5 ms │ 8 ms │ 20 ms │ 36 ms │ 8.79 ms │ 4.44 ms │ 78 ms │
└─────────┴──────┴──────┴───────┴───────┴─────────┴─────────┴───────┘
┌───────────┬─────────┬─────────┬─────────┬─────────┬─────────┬────────┬─────────┐
│ Stat      │ 1%      │ 2.5%    │ 50%     │ 97.5%   │ Avg     │ Stdev  │ Min     │
├───────────┼─────────┼─────────┼─────────┼─────────┼─────────┼────────┼─────────┤
│ Req/Sec   │ 3649    │ 3649    │ 5475    │ 5687    │ 5383.75 │ 421.22 │ 3649    │
├───────────┼─────────┼─────────┼─────────┼─────────┼─────────┼────────┼─────────┤
│ Bytes/Sec │ 7.63 MB │ 7.63 MB │ 11.4 MB │ 11.9 MB │ 11.2 MB │ 878 kB │ 7.62 MB │
└───────────┴─────────┴─────────┴─────────┴─────────┴─────────┴────────┴─────────┘

108k requests in 20.03s, 225 MB read
```

100 connections x 10 seconds
```
┌─────────┬───────┬───────┬───────┬───────┬──────────┬─────────┬───────┐
│ Stat    │ 2.5%  │ 50%   │ 97.5% │ 99%   │ Avg      │ Stdev   │ Max   │
├─────────┼───────┼───────┼───────┼───────┼──────────┼─────────┼───────┤
│ Latency │ 13 ms │ 17 ms │ 38 ms │ 56 ms │ 18.12 ms │ 6.83 ms │ 74 ms │
└─────────┴───────┴───────┴───────┴───────┴──────────┴─────────┴───────┘
┌───────────┬────────┬────────┬─────────┬─────────┬─────────┬────────┬─────────┐
│ Stat      │ 1%     │ 2.5%   │ 50%     │ 97.5%   │ Avg     │ Stdev  │ Min     │
├───────────┼────────┼────────┼─────────┼─────────┼─────────┼────────┼─────────┤
│ Req/Sec   │ 4407   │ 4407   │ 5455    │ 5591    │ 5368    │ 344.44 │ 4405    │
├───────────┼────────┼────────┼─────────┼─────────┼─────────┼────────┼─────────┤
│ Bytes/Sec │ 9.2 MB │ 9.2 MB │ 11.4 MB │ 11.7 MB │ 11.2 MB │ 721 kB │ 9.19 MB │
└───────────┴────────┴────────┴─────────┴─────────┴─────────┴────────┴─────────┘

54k requests in 10.02s, 112 MB read
```

### MySQL

100000 entities average initialization time on 3 runs `183374ms`

10 connections x 30 seconds
```
┌─────────┬──────┬──────┬───────┬───────┬─────────┬─────────┬────────┐
│ Stat    │ 2.5% │ 50%  │ 97.5% │ 99%   │ Avg     │ Stdev   │ Max    │
├─────────┼──────┼──────┼───────┼───────┼─────────┼─────────┼────────┤
│ Latency │ 1 ms │ 4 ms │ 17 ms │ 21 ms │ 5.55 ms │ 8.14 ms │ 470 ms │
└─────────┴──────┴──────┴───────┴───────┴─────────┴─────────┴────────┘
┌───────────┬─────────┬─────────┬─────────┬─────────┬─────────┬────────┬─────────┐
│ Stat      │ 1%      │ 2.5%    │ 50%     │ 97.5%   │ Avg     │ Stdev  │ Min     │
├───────────┼─────────┼─────────┼─────────┼─────────┼─────────┼────────┼─────────┤
│ Req/Sec   │ 768     │ 768     │ 1516    │ 2791    │ 1653.44 │ 479.44 │ 768     │
├───────────┼─────────┼─────────┼─────────┼─────────┼─────────┼────────┼─────────┤
│ Bytes/Sec │ 1.56 MB │ 1.56 MB │ 3.08 MB │ 5.67 MB │ 3.36 MB │ 974 kB │ 1.56 MB │
└───────────┴─────────┴─────────┴─────────┴─────────┴─────────┴────────┴─────────┘

50k requests in 30.06s, 101 MB read
```

50 connections x 20 seconds
```
┌─────────┬───────┬───────┬───────┬───────┬──────────┬──────────┬────────┐
│ Stat    │ 2.5%  │ 50%   │ 97.5% │ 99%   │ Avg      │ Stdev    │ Max    │
├─────────┼───────┼───────┼───────┼───────┼──────────┼──────────┼────────┤
│ Latency │ 27 ms │ 39 ms │ 71 ms │ 80 ms │ 41.51 ms │ 11.51 ms │ 137 ms │
└─────────┴───────┴───────┴───────┴───────┴──────────┴──────────┴────────┘
┌───────────┬─────────┬─────────┬─────────┬─────────┬─────────┬────────┬─────────┐
│ Stat      │ 1%      │ 2.5%    │ 50%     │ 97.5%   │ Avg     │ Stdev  │ Min     │
├───────────┼─────────┼─────────┼─────────┼─────────┼─────────┼────────┼─────────┤
│ Req/Sec   │ 899     │ 899     │ 1210    │ 1292    │ 1189.16 │ 95.98  │ 899     │
├───────────┼─────────┼─────────┼─────────┼─────────┼─────────┼────────┼─────────┤
│ Bytes/Sec │ 1.83 MB │ 1.83 MB │ 2.46 MB │ 2.62 MB │ 2.42 MB │ 194 kB │ 1.83 MB │
└───────────┴─────────┴─────────┴─────────┴─────────┴─────────┴────────┴─────────┘

24k requests in 20.03s, 48.3 MB read
```

100 connections x 10 seconds
```
┌─────────┬───────┬───────┬────────┬────────┬──────────┬──────────┬────────┐
│ Stat    │ 2.5%  │ 50%   │ 97.5%  │ 99%    │ Avg      │ Stdev    │ Max    │
├─────────┼───────┼───────┼────────┼────────┼──────────┼──────────┼────────┤
│ Latency │ 69 ms │ 86 ms │ 134 ms │ 145 ms │ 90.64 ms │ 17.19 ms │ 197 ms │
└─────────┴───────┴───────┴────────┴────────┴──────────┴──────────┴────────┘
┌───────────┬─────────┬─────────┬─────────┬─────────┬─────────┬────────┬─────────┐
│ Stat      │ 1%      │ 2.5%    │ 50%     │ 97.5%   │ Avg     │ Stdev  │ Min     │
├───────────┼─────────┼─────────┼─────────┼─────────┼─────────┼────────┼─────────┤
│ Req/Sec   │ 883     │ 883     │ 1086    │ 1216    │ 1091.3  │ 97.14  │ 883     │
├───────────┼─────────┼─────────┼─────────┼─────────┼─────────┼────────┼─────────┤
│ Bytes/Sec │ 1.79 MB │ 1.79 MB │ 2.21 MB │ 2.48 MB │ 2.22 MB │ 198 kB │ 1.79 MB │
└───────────┴─────────┴─────────┴─────────┴─────────┴─────────┴────────┴─────────┘

11k requests in 10.03s, 22.2 MB read
```

# Conclusion

## Bulk insert operations

MongoDb is `9.1` times faster on average in this test case than MySQL.

## Single random read operations

MongoDb has `2-5` times less latency and handles `2-5` times more requests per second than MySQL.
